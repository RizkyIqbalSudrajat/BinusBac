<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profil - Binus SafeLine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS SAMA SEPERTI DASHBOARD --- */
        :root { --primary: #0088CC; --text-dark: #333; --text-grey: #888; --bg-light: #F8F9FA; --white: #FFFFFF; --sidebar-width: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-light); display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--white); padding: 30px 20px; position: fixed; height: 100vh; border-right: 1px solid #eee; display: flex; flex-direction: column; }
        .brand { margin-bottom: 40px; padding-left: 10px; }
        .brand h2 { font-size: 1.5rem; color: #000; font-weight: bold; }
        .brand span { font-size: 0.9rem; color: var(--text-grey); display: block; margin-top: 5px; }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { text-decoration: none; padding: 12px 20px; border-radius: 8px; color: var(--text-grey); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: 0.3s; border: 1px solid transparent; }
        .menu-item i { width: 25px; text-align: center; }
        .menu-item:hover { background-color: #f0f8ff; color: var(--primary); padding-left: 25px; }
        .menu-item.active { background-color: var(--primary); color: var(--white); box-shadow: 0 4px 10px rgba(0, 136, 204, 0.3); }
        .logout-link { margin-top: auto; color: #E76F51; }

        /* Main Content Style */
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 40px; }

        .form-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; }
        .form-card h2 { color: var(--primary); margin-bottom: 30px; text-align: center; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; color: #666; }

        /* FOTO PROFILE STYLE */
        .profile-upload { text-align: center; margin-bottom: 30px; }
        .avatar-preview {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            border: 4px solid #eee; margin-bottom: 15px;
            cursor: pointer; transition: 0.3s;
        }
        .avatar-preview:hover { opacity: 0.8; border-color: var(--primary); }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        .btn-upload {
            border: 1px solid var(--primary); color: var(--primary);
            background-color: white; padding: 8px 20px; border-radius: 20px;
            font-size: 0.9rem; font-weight: bold; cursor: pointer;
        }

        .btn-save { background: var(--primary); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.3s; width: 100%; margin-top: 10px; }
        .btn-save:hover { background-color: #006699; }
        .btn-back { background: #ccc; color: #333; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; width: 100%; display: block; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <h2>Binus SafeLine</h2>
            <span>Semesta Apps</span>
        </div>
        <nav class="menu">
            <a href="dashboard.html" class="menu-item"> <i class="fas fa-th-large"></i> Dashboard </a>
            <a href="#" class="menu-item active"> <i class="fas fa-user-cog"></i> Edit Profil </a> 
            <a href="index.html" class="menu-item logout-link" onclick="localStorage.clear()"> <i class="fas fa-sign-out-alt"></i> Logout </a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="form-card">
            <h2>Edit Profil Saya</h2>
            
            <form id="editProfileForm" enctype="multipart/form-data">
                
                <div class="profile-upload">
                    <img id="avatarPreview" src="https://ui-avatars.com/api/?name=User&background=random" class="avatar-preview" onclick="document.getElementById('fotoInput').click()">
                    <br>
                    <div class="upload-btn-wrapper">
                        <button class="btn-upload" type="button" onclick="document.getElementById('fotoInput').click()">
                            <i class="fas fa-camera"></i> Ganti Foto
                        </button>
                        <input type="file" id="fotoInput" name="foto" accept="image/*" onchange="previewImage(this)">
                    </div>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Klik gambar untuk mengganti</p>
                </div>

                <div class="form-group">
                    <label>NIM (Tidak dapat diubah)</label>
                    <input type="text" id="nim" readonly>
                </div>

                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="nama" name="nama" required>
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <p style="margin-bottom: 15px; color: #888; font-size: 0.9rem;">Kosongkan password jika tidak ingin menggantinya.</p>

                <div class="form-group">
                    <label>Password Baru</label>
                    <input type="password" id="password" name="password" placeholder="Masukkan password baru">
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn-save">Simpan Perubahan</button>
                    <a href="dashboard.html" class="btn-back">Kembali ke Dashboard</a>
                </div>

            </form>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8080/api";
        const userNim = localStorage.getItem('userNim');

        // 1. SAAT LOAD: Ambil data user dari Backend
        document.addEventListener("DOMContentLoaded", async function() {
            if (!userNim) {
                alert("Sesi tidak valid.");
                window.location.href = "index.html";
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/${userNim}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('nim').value = data.nim;
                    document.getElementById('nama').value = data.nama;

                    // Load Foto Profil jika ada
                    if (data.fotoProfile) {
                        // Gunakan API endpoint file yang sudah kita buat sebelumnya di LaporanController
                        // Atau jika UserController, bisa juga arahkan ke folder static
                        // Asumsi: Kita pakai endpoint generic file atau static resource
                        document.getElementById('avatarPreview').src = `${API_URL}/laporan/file/${data.fotoProfile}`;
                    } else {
                        // Default Avatar
                        document.getElementById('avatarPreview').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nama)}&background=random`;
                    }

                } else {
                    alert("Gagal mengambil data profil.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });

        // 2. FUNGSI PREVIEW GAMBAR SEBELUM UPLOAD
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. SAAT SUBMIT: Kirim FormData ke Backend
        document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.querySelector('.btn-save');
            btn.innerHTML = 'Menyimpan...';
            btn.disabled = true;

            const form = document.getElementById('editProfileForm');
            const formData = new FormData(form); 
            // FormData otomatis mengambil input[name="nama"], input[name="password"], input[name="foto"]

            try {
                const response = await fetch(`${API_URL}/users/${userNim}`, {
                    method: 'PUT',
                    body: formData // Jangan set Content-Type header saat kirim FormData
                });

                if (response.ok) {
                    alert("Profil berhasil diperbarui!");
                    // Update nama di localStorage
                    const newName = document.getElementById('nama').value;
                    localStorage.setItem('userNama', newName);
                    
                    window.location.href = "dashboard.html";
                } else {
                    alert("Gagal memperbarui profil.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Terjadi kesalahan koneksi.");
            } finally {
                btn.innerHTML = 'Simpan Perubahan';
                btn.disabled = false;
            }
        });
    </script>

</body>
</html>