<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binus SafeLine - Buat Laporan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS SAMA SEPERTI SEBELUMNYA --- */
        :root { --primary: #0088CC; --secondary: #264653; --text-dark: #333; --text-grey: #666; --bg-light: #F8F9FA; --white: #FFFFFF; --sidebar-width: 260px; --border-radius: 8px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-light); display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--white); padding: 30px 20px; position: fixed; height: 100vh; border-right: 1px solid #eee; display: flex; flex-direction: column; z-index: 100; }
        .brand { margin-bottom: 40px; padding-left: 10px; }
        .brand h2 { font-size: 1.5rem; color: #000; font-weight: bold; }
        .brand span { font-size: 0.9rem; color: var(--text-grey); display: block; margin-top: 5px; }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { text-decoration: none; padding: 12px 20px; border-radius: 8px; color: var(--text-grey); font-weight: 500; display: flex; align-items: center; gap: 15px; transition: all 0.3s ease; border: 1px solid transparent; }
        .menu-item i { width: 25px; text-align: center; display: inline-block; }
        .menu-item:hover { background-color: #f0f8ff; color: var(--primary); padding-left: 25px; }
        .menu-item.active { background-color: var(--primary); color: var(--white); box-shadow: 0 4px 10px rgba(0, 136, 204, 0.3); }
        .logout-link { margin-top: auto; color: #E76F51; }
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 40px; width: calc(100% - var(--sidebar-width)); }
        .page-title { margin-bottom: 30px; color: var(--secondary); }
        
        /* FORM STYLES */
        .form-card { background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 900px; }
        .section-title { color: var(--primary); margin-bottom: 20px; font-size: 1.1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: inline-block; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; font-size: 0.95rem; }
        input[type="text"], input[type="datetime-local"], select, textarea, input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; outline: none; transition: border 0.3s; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1); }
        textarea { resize: vertical; min-height: 100px; }
        .checkbox-group { background: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .checkbox-item input { width: 18px; height: 18px; accent-color: var(--primary); }
        .btn-submit { background-color: var(--primary); color: white; padding: 15px 30px; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-submit:hover { background-color: #006699; box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <h2>Binus SafeLine</h2>
            <span>Semesta Apps</span>
        </div>
        <nav class="menu">
            <a href="dashboard.html" class="menu-item"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="lapor.html" class="menu-item active"><i class="fas fa-edit"></i> Buat Laporan</a>
            <a href="riwayatlaporan.html" class="menu-item"><i class="fas fa-book"></i> Riwayat Laporan</a>
            <a href="konselor.html" class="menu-item"><i class="fas fa-comments"></i> Chat Konselor</a>
            <a href="edukasi.html" class="menu-item"><i class="fas fa-bullhorn"></i> Pusat Edukasi</a>
            <a href="index.html" class="menu-item logout-link" onclick="localStorage.clear()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </aside>

    <main class="main-content">
        <h2 class="page-title">Buat Laporan Baru</h2>

        <div class="form-card">
            <form id="laporForm">
                <h4 class="section-title"><i class="fas fa-user-shield"></i> Identitas Pelapor</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="namaPelapor" name="nama" readonly style="background-color: #eee;">
                    </div>
                    <div class="form-group">
                        <label>NIM</label>
                        <input type="text" id="nimPelapor" name="nim" readonly style="background-color: #eee;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Program Studi</label>
                    <input type="text" id="prodiPelapor" name="prodi" readonly style="background-color: #eee;" placeholder="Memuat...">
                </div>

                <h4 class="section-title" style="margin-top: 20px;"><i class="fas fa-exclamation-triangle"></i> Detail Kejadian</h4>
                
                <div class="form-group">
                    <label>Judul Laporan</label>
                    <input type="text" name="judul" placeholder="Contoh: Pemalakan di Area Parkir" required>
                </div>

                <div class="form-group">
                    <label>Jenis Kasus Bullying</label>
                    <select name="kategori" required>
                        <option value="">-- Pilih Kategori --</option>
                        <option value="Verbal">Bullying Verbal (Hinaan, ejekan)</option>
                        <option value="Fisik">Bullying Fisik (Pukulan, dorongan)</option>
                        <option value="Cyber">Cyberbullying (Media sosial, chat)</option>
                        <option value="Sosial">Bullying Sosial (Pengucilan)</option>
                        <option value="Seksual">Pelecehan Seksual</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tempat Kejadian</label>
                        <input type="text" name="tempat" placeholder="Misal: Kantin, Lab 724, Grup WA" required>
                    </div>
                    <div class="form-group">
                        <label>Waktu Kejadian</label>
                        <input type="datetime-local" name="waktu" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Kronologi / Deskripsi Masalah</label>
                    <textarea name="deskripsi" placeholder="Ceritakan apa yang terjadi secara rinci..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Upload Bukti (Maks. 50MB)</label>
                    <input type="file" id="buktiFile" name="bukti" accept="image/*, application/pdf, video/*">
                    <small style="color: #888; margin-top:5px; display:block;">Format: JPG, PNG, PDF, MP4, AVI. Maksimal 50MB.</small>
                </div>

                <h4 class="section-title" style="margin-top: 20px;"><i class="fas fa-lock"></i> Privasi & Keamanan</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="anonim" name="anonim">
                        <label for="anonim"><strong>Laporan Anonim</strong> (Sembunyikan nama saya dari admin)</label>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> Kirim Laporan Sekarang
                </button>
            </form>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8080/api";

        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Ambil NIM dari LocalStorage
            const nim = localStorage.getItem('userNim');

            if (!nim) {
                alert("Anda belum login! Mengarahkan ke halaman login...");
                window.location.href = 'index.html';
                return;
            }

            // 2. Fetch Data Lengkap User dari Database (Termasuk Jurusan)
            try {
                const response = await fetch(`${API_URL}/users/${nim}`);
                
                if (response.ok) {
                    const user = await response.json();
                    
                    // Isi form secara otomatis
                    document.getElementById('namaPelapor').value = user.nama;
                    document.getElementById('nimPelapor').value = user.nim;
                    document.getElementById('prodiPelapor').value = user.jurusan || "Tidak Diketahui"; // Otomatis mengisi jurusan
                } else {
                    console.error("Gagal mengambil data user");
                    // Fallback: Jika fetch gagal, ambil nama dari localStorage
                    const savedNama = localStorage.getItem('userNama');
                    if(savedNama) document.getElementById('namaPelapor').value = savedNama;
                    document.getElementById('nimPelapor').value = nim;
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });

        document.getElementById('laporForm').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            // --- VALIDASI FILE DI SINI ---
            const fileInput = document.getElementById('buktiFile');
            const file = fileInput.files[0];
            
            if (file) {
                // 1. Validasi Ukuran File (50MB = 50 * 1024 * 1024 bytes)
                const maxSize = 50 * 1024 * 1024; 
                if (file.size > maxSize) {
                    alert("Ukuran file terlalu besar! Maksimal 50MB.");
                    return; // Stop proses kirim
                }

                // 2. Validasi Tipe File (Mencegah upload .exe atau file berbahaya)
                // Note: video/quicktime untuk .mov, video/x-msvideo untuk .avi
                const isValidType = file.type.startsWith('image/') || file.type.startsWith('video/') || file.type === 'application/pdf';

                if (!isValidType) {
                    alert("Format file tidak didukung! Harap upload Foto, Video, atau PDF.");
                    return; // Stop proses kirim
                }
            }
            // --- END VALIDASI ---

            const form = e.target;
            const formData = new FormData(form);
            formData.set('anonim', document.getElementById('anonim').checked); 

            // Ubah tombol jadi Loading agar user tahu sedang proses upload
            const btnSubmit = document.querySelector('.btn-submit');
            const originalText = btnSubmit.innerHTML;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
            btnSubmit.disabled = true;

            try {
                const response = await fetch(`${API_URL}/laporan/create`, {
                    method: 'POST',
                    body: formData 
                });

                if (response.ok) {
                    const result = await response.text();
                    alert(result); 
                    window.location.href = 'riwayatlaporan.html'; 
                } else {
                    const errorText = await response.text();
                    alert("Gagal mengirim laporan: " + errorText);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Terjadi kesalahan koneksi. Kemungkinan file terlalu besar atau server mati.");
            } finally {
                // Kembalikan tombol seperti semula
                btnSubmit.innerHTML = originalText;
                btnSubmit.disabled = false;
            }
        });
    </script>
</body>
</html>