<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAC Admin - Detail Mahasiswa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #264653; 
            --accent: #2A9D8F;
            --warning: #E9C46A;
            --danger: #E76F51;
            --bg-light: #F4F7F6;
            --white: #FFFFFF;
            --sidebar-width: 260px;
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-light); display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; padding: 30px 20px; position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100; }
        .brand { margin-bottom: 40px; padding-left: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .brand h2 { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { text-decoration: none; padding: 12px 20px; border-radius: 8px; color: #ccc; font-weight: 500; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--accent); }
        .menu-item i { width: 25px; text-align: center; }
        .logout-link { margin-top: auto; color: #E76F51 !important; }

        /* Main Content */
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 40px; width: calc(100% - var(--sidebar-width)); }
        
        .back-btn { display: inline-flex; align-items: center; gap: 10px; text-decoration: none; color: #666; font-weight: 600; margin-bottom: 20px; transition: 0.3s; }
        .back-btn:hover { color: var(--primary); }

        /* Profile Header Card */
        .profile-card {
            background: white; padding: 30px; border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 30px;
            margin-bottom: 40px; position: relative; overflow: hidden;
            border-left: 5px solid #28a745;
        }
        .profile-card.is-reported { border-left-color: var(--danger); }

        .avatar-lg { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #eee; object-fit: cover; }
        .profile-info h2 { margin-bottom: 5px; color: var(--primary); }
        .profile-meta { color: #666; font-size: 1rem; margin-bottom: 10px; display: block; }
        
        .status-badge {
            padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
            display: inline-block; background: #d4edda; color: #155724;
        }
        .is-reported .status-badge { background: #f8d7da; color: #721c24; }

        /* History List */
        .section-title { font-size: 1.2rem; margin-bottom: 20px; color: var(--primary); border-bottom: 2px solid #ddd; padding-bottom: 10px; display: inline-block; }
        
        .report-list { display: flex; flex-direction: column; gap: 15px; }
        
        .report-item {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid #ccc; transition: 0.3s;
        }
        .report-item:hover { transform: translateX(5px); }

        /* Status Border & Badge Colors */
        .status-diterima { border-left-color: var(--warning); }
        .status-diproses { border-left-color: var(--accent); }
        .status-selesai { border-left-color: var(--primary); }
        .status-ditolak { border-left-color: var(--danger); }

        .bg-diterima { background: var(--warning); color: #333; }
        .bg-diproses { background: var(--accent); }
        .bg-selesai { background: var(--primary); }
        .bg-ditolak { background: var(--danger); }

        .ri-left h4 { margin-bottom: 5px; color: #333; }
        .ri-left span { font-size: 0.9rem; color: #888; }
        .ticket-id { font-family: monospace; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }

        .ri-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .badge-status { padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: white; display: inline-block; }
        
        .btn-sm-detail {
            text-decoration: none; font-size: 0.8rem; color: var(--primary); 
            border: 1px solid var(--primary); padding: 4px 12px; border-radius: 15px; 
            transition: 0.2s; background: transparent; cursor: pointer;
        }
        .btn-sm-detail:hover { background: var(--primary); color: white; }

        .loading-state, .empty-state { text-align: center; padding: 40px; color: #888; width: 100%; background: white; border-radius: 8px; }

        /* --- MODAL (POPUP) STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 60%; max-width: 800px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideIn 0.3s; }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .detail-row { display: flex; border-bottom: 1px solid #eee; padding: 10px 0; }
        .detail-label { font-weight: bold; width: 180px; color: #555; }
        .detail-value { flex: 1; color: #333; }
        .proof-img { max-width: 100%; max-height: 400px; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
        .modal-header { margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .modal-header h3 { color: var(--primary); margin-bottom: 5px; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; }
            .profile-card { flex-direction: column; text-align: center; }
            .report-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .ri-right { align-items: flex-start; width: 100%; text-align: left; flexDirection: row; justify-content: space-between; }
            .modal-content { width: 90%; }
            .detail-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><h2>BAC ADMIN</h2><span>Panel Pengelola</span></div>
        <nav class="menu">
            <a href="dashboardadmin.html" class="menu-item"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="laporan.html" class="menu-item"><i class="fas fa-inbox"></i> Laporan Masuk</a>
            <a href="daftarmahasiswa.html" class="menu-item active"><i class="fas fa-users"></i> Data Mahasiswa</a>
            <a href="konsultan.html" class="menu-item"><i class="fas fa-user-md"></i> Konsultan</a>
            <a href="../index.html" class="menu-item logout-link" onclick="localStorage.clear()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </aside>

    <main class="main-content">
        <a href="daftarmahasiswa.html" class="back-btn"><i class="fas fa-arrow-left"></i> Kembali ke Daftar Mahasiswa</a>

        <div class="profile-card" id="profileCard">
            <div class="loading-state" style="box-shadow:none; padding:0;">Loading Profile...</div>
        </div>

        <h3 class="section-title">Riwayat Laporan (Non-Anonim)</h3>
        
        <div class="report-list" id="reportList">
            <div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Memuat riwayat...</div>
        </div>
    </main>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3 id="modalJudul">Judul Laporan</h3>
                <span id="modalTicket" style="background:#eee; padding:2px 8px; border-radius:4px; font-family:monospace; margin-right: 10px;">#LP-000</span>
                <span id="modalStatus" class="badge-status">Status</span>
            </div>
            <div class="detail-row">
                <div class="detail-label">Tanggal Kejadian</div>
                <div class="detail-value" id="modalWaktu">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Kategori</div>
                <div class="detail-value" id="modalKategori">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Tempat Kejadian</div>
                <div class="detail-value" id="modalTempat">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Data Pelapor</div>
                <div class="detail-value" id="modalPelapor">-</div>
            </div>
            <div class="detail-row" style="flex-direction: column;">
                <div class="detail-label" style="margin-bottom:10px;">Kronologi / Deskripsi</div>
                <div class="detail-value" id="modalDeskripsi" style="background:#f9f9f9; padding:15px; border-radius:8px; line-height:1.6; text-align: justify;">-</div>
            </div>
            <div class="detail-row" style="flex-direction: column; border-bottom: none;">
                <div class="detail-label" style="margin-bottom:10px;">Bukti Lampiran</div>
                <div class="detail-value" id="modalBuktiContainer">
                    <span style="color:#888;">Tidak ada bukti lampiran.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api";
        let userReports = []; // Menyimpan data laporan (yang sudah difilter) untuk akses Modal

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetNim = urlParams.get('nim');

            if (!targetNim) {
                alert("User tidak ditemukan!");
                window.location.href = 'daftarmahasiswa.html';
                return;
            }

            loadUserProfile(targetNim);
        });

        async function loadUserProfile(nim) {
            try {
                // 1. Fetch User Data
                const resUser = await fetch(`${API_URL}/users/${nim}`);
                if (!resUser.ok) throw new Error("Gagal mengambil data user");
                const user = await resUser.json();

                // 2. Fetch Reports
                const resReports = await fetch(`${API_URL}/laporan/history/${nim}`);
                const reports = await resReports.ok ? await resReports.json() : [];

                // --- 3. FILTER LAPORAN: HANYA YANG TIDAK ANONIM ---
                const visibleReports = reports.filter(r => !r.anonim);
                userReports = visibleReports; // Simpan ke global variable

                // Hitung Status (Berdasarkan laporan yang visible)
                const activeCases = visibleReports.filter(r => r.status === 'Diterima' || r.status === 'Diproses');
                const isReported = activeCases.length > 0;

                // 4. Render Profile
                let avatarUrl = '';
                if (user.fotoProfile) {
                    avatarUrl = `${API_URL}/users/foto/${user.fotoProfile}`;
                } else {
                    avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nama)}&background=random&size=128`;
                }

                let statusBadge = isReported 
                    ? `<span class="status-badge">⚠️ Terlapor (${activeCases.length} Kasus Aktif)</span>`
                    : `<span class="status-badge"><i class="fas fa-check-circle"></i> Active (Good)</span>`;

                const profileHTML = `
                    <img src="${avatarUrl}" class="avatar-lg" alt="Avatar" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.nama)}&background=random&size=128';">
                    <div class="profile-info">
                        <h2>${user.nama}</h2>
                        <span class="profile-meta">
                            <i class="fas fa-id-card"></i> ${user.nim} &nbsp;|&nbsp; 
                            <i class="fas fa-graduation-cap"></i> ${user.jurusan || '-'}
                        </span>
                        ${statusBadge}
                    </div>
                `;
                
                const profileCard = document.getElementById('profileCard');
                profileCard.innerHTML = profileHTML;
                
                if (isReported) profileCard.classList.add('is-reported');
                else profileCard.classList.remove('is-reported');

                // 5. Render Report List (Gunakan data yang sudah difilter)
                renderReports(visibleReports);

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('profileCard').innerHTML = `<div class="empty-state">Gagal memuat profil user.</div>`;
            }
        }

        function renderReports(reports) {
            const container = document.getElementById('reportList');
            container.innerHTML = '';

            if (reports.length === 0) {
                container.innerHTML = `<div class="empty-state">User ini belum pernah membuat laporan (Non-Anonim).</div>`;
                return;
            }

            reports.forEach((report, index) => {
                const dateObj = new Date(report.waktuKejadian);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                const statusLower = report.status.toLowerCase();
                let badgeClass = 'bg-diterima';
                if(statusLower === 'diproses') badgeClass = 'bg-diproses';
                else if(statusLower === 'selesai') badgeClass = 'bg-selesai';
                else if(statusLower === 'ditolak') badgeClass = 'bg-ditolak';

                const html = `
                    <div class="report-item status-${statusLower}">
                        <div class="ri-left">
                            <h4>${report.judulLaporan || 'Tanpa Judul'}</h4>
                            <span>
                                <span class="ticket-id">#LP-${report.id}</span> &bull; 
                                ${dateStr} &bull; ${report.kategori}
                            </span>
                        </div>
                        <div class="ri-right">
                            <span class="badge-status ${badgeClass}">${report.status}</span>
                            <button class="btn-sm-detail" onclick="showDetail(${index})">
                                <i class="fas fa-eye"></i> Lihat Detail
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- MODAL LOGIC ---
        function showDetail(index) {
            // Ambil dari array yang sudah difilter
            const report = userReports[index];
            const dateObj = new Date(report.waktuKejadian);
            const fullDate = dateObj.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });

            document.getElementById('modalJudul').innerText = report.judulLaporan || 'Tanpa Judul';
            document.getElementById('modalTicket').innerText = "#LP-" + report.id;
            document.getElementById('modalWaktu').innerText = fullDate;
            document.getElementById('modalKategori').innerText = report.kategori;
            document.getElementById('modalTempat').innerText = report.tempatKejadian;
            document.getElementById('modalDeskripsi').innerText = report.deskripsi;

            const statusEl = document.getElementById('modalStatus');
            statusEl.innerText = report.status;
            statusEl.className = 'badge-status';
            if(report.status === 'Diterima') statusEl.classList.add('bg-diterima');
            else if(report.status === 'Diproses') statusEl.classList.add('bg-diproses');
            else if(report.status === 'Selesai') statusEl.classList.add('bg-selesai');
            else statusEl.classList.add('bg-ditolak');

            // Data Pelapor (Karena sudah difilter, pasti Non-Anonim)
            document.getElementById('modalPelapor').innerText = `${report.namaPelapor} (${report.nimPelapor}) - ${report.programStudi}`;

            // Bukti
            const buktiContainer = document.getElementById('modalBuktiContainer');
            if (report.buktiFoto) {
                const fileUrl = `${API_URL}/laporan/file/${report.buktiFoto}`;
                if(report.buktiFoto.endsWith('.mp4') || report.buktiFoto.endsWith('.avi')) {
                    buktiContainer.innerHTML = `<video controls style="max-width:100%; border-radius:8px;"><source src="${fileUrl}" type="video/mp4"></video>`;
                } else if (report.buktiFoto.endsWith('.pdf')) {
                    buktiContainer.innerHTML = `<a href="${fileUrl}" target="_blank" class="btn-sm-detail">Buka Dokumen PDF</a>`;
                } else {
                    buktiContainer.innerHTML = `<img src="${fileUrl}" class="proof-img" alt="Bukti Laporan">`;
                }
            } else {
                buktiContainer.innerHTML = '<span style="color:#888;">Tidak ada bukti yang dilampirkan.</span>';
            }

            document.getElementById('detailModal').style.display = "block";
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

</body>
</html>